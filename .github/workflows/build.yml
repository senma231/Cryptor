name: 打包多平台可执行文件

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write
  packages: read

jobs:
  build-windows:
    name: 打包 Windows 可执行文件
    runs-on: windows-latest
    
    steps:
    - name: 检出代码
      uses: actions/checkout@v4
    
    - name: 设置 Python 环境
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: 安装依赖
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
    
    - name: 运行 PyInstaller 打包
      run: |
        pyinstaller --clean `
          --name="量化交易系统" `
          --windowed `
          --onefile `
          --icon=icon.ico `
          --add-data "icon.png;." `
          --add-data "backtest_worker.py;." `
          --add-data "download_worker.py;." `
          --add-data "paper_trading_worker.py;." `
          --add-data "config;config" `
          --add-data "strategies;strategies" `
          --add-data "tools;tools" `
          --hidden-import=PyQt5 `
          --hidden-import=pandas `
          --hidden-import=numpy `
          --hidden-import=cryptography `
          --hidden-import=ccxt `
          --hidden-import=requests `
          --collect-all=PyQt5 `
          --collect-all=pandas `
          --collect-all=numpy `
          trading_gui.py
      shell: pwsh
    
    - name: 重命名可执行文件为英文
      run: |
        mv "dist/量化交易系统.exe" "dist/Cryptor-Trading-System.exe"

    - name: 上传 Windows 可执行文件
      uses: actions/upload-artifact@v4
      with:
        name: windows-executable
        path: dist/Cryptor-Trading-System.exe
        retention-days: 30

  # macOS Intel 构建已被 GitHub 弃用，暂时禁用
  # build-macos-intel:
  #   name: 打包 macOS Intel 可执行文件
  #   runs-on: macos-13

  build-macos-arm:
    name: 打包 macOS Apple Silicon 可执行文件
    runs-on: macos-latest  # Apple Silicon Mac

    steps:
    - name: 检出代码
      uses: actions/checkout@v4

    - name: 设置 Python 环境
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'

    - name: 安装依赖
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller

    - name: 运行 PyInstaller 打包
      run: |
        pyinstaller --clean \
          --name="量化交易系统" \
          --windowed \
          --onefile \
          --icon=icon.ico \
          --add-data "icon.png:." \
          --add-data "backtest_worker.py:." \
          --add-data "download_worker.py:." \
          --add-data "paper_trading_worker.py:." \
          --add-data "config:config" \
          --add-data "strategies:strategies" \
          --add-data "tools:tools" \
          --hidden-import=PyQt5 \
          --hidden-import=pandas \
          --hidden-import=numpy \
          --hidden-import=cryptography \
          --hidden-import=ccxt \
          --hidden-import=requests \
          --collect-all=PyQt5 \
          --collect-all=pandas \
          --collect-all=numpy \
          trading_gui.py

    - name: 创建 .app 包
      run: |
        mkdir -p "量化交易系统.app/Contents/MacOS"
        mkdir -p "量化交易系统.app/Contents/Resources"
        cp dist/量化交易系统 "量化交易系统.app/Contents/MacOS/"
        cp icon.png "量化交易系统.app/Contents/Resources/"

        cat > "量化交易系统.app/Contents/Info.plist" << EOF
        <?xml version="1.0" encoding="UTF-8"?>
        <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
        <plist version="1.0">
        <dict>
            <key>CFBundleExecutable</key>
            <string>量化交易系统</string>
            <key>CFBundleIconFile</key>
            <string>icon.png</string>
            <key>CFBundleIdentifier</key>
            <string>com.cryptor.trading</string>
            <key>CFBundleName</key>
            <string>量化交易系统</string>
            <key>CFBundlePackageType</key>
            <string>APPL</string>
            <key>CFBundleShortVersionString</key>
            <string>2.0.0</string>
        </dict>
        </plist>
        EOF

        chmod +x "量化交易系统.app/Contents/MacOS/量化交易系统"
        zip -r "Cryptor-Trading-System-macOS-ARM.zip" "量化交易系统.app"

    - name: 上传 macOS ARM 可执行文件
      uses: actions/upload-artifact@v4
      with:
        name: macos-arm-executable
        path: Cryptor-Trading-System-macOS-ARM.zip
        retention-days: 30

  create-release:
    name: 创建 GitHub Release
    needs: [build-windows, build-macos-arm]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')

    steps:
    - name: 下载所有 artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts

    - name: 显示下载的文件
      run: |
        echo "下载的 artifacts:"
        ls -R artifacts/

    - name: 上传文件到 Release
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        # 上传文件到已存在的 Release
        gh release upload ${{ github.ref_name }} \
          --repo ${{ github.repository }} \
          --clobber \
          artifacts/windows-executable/Cryptor-Trading-System.exe#量化交易系统.exe \
          artifacts/macos-arm-executable/Cryptor-Trading-System-macOS-ARM.zip#量化交易系统-macOS-ARM.zip

