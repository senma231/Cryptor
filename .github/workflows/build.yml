name: æ‰“åŒ…å¤šå¹³å°å¯æ‰§è¡Œæ–‡ä»¶

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write
  packages: read

jobs:
  build-windows:
    name: æ‰“åŒ… Windows å¯æ‰§è¡Œæ–‡ä»¶
    runs-on: windows-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
    
    - name: è®¾ç½® Python ç¯å¢ƒ
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
    
    - name: è¿è¡Œ PyInstaller æ‰“åŒ…
      run: |
        pyinstaller --clean `
          --name="é‡åŒ–äº¤æ˜“ç³»ç»Ÿ" `
          --windowed `
          --onefile `
          --icon=icon.ico `
          --add-data "icon.png;." `
          --add-data "backtest_worker.py;." `
          --add-data "download_worker.py;." `
          --add-data "paper_trading_worker.py;." `
          --add-data "config;config" `
          --add-data "strategies;strategies" `
          --add-data "tools;tools" `
          --hidden-import=PyQt5 `
          --hidden-import=pandas `
          --hidden-import=numpy `
          --hidden-import=cryptography `
          --hidden-import=ccxt `
          --hidden-import=requests `
          --collect-all=PyQt5 `
          --collect-all=pandas `
          --collect-all=numpy `
          trading_gui.py
      shell: pwsh
    
    - name: ä¸Šä¼  Windows å¯æ‰§è¡Œæ–‡ä»¶
      uses: actions/upload-artifact@v4
      with:
        name: é‡åŒ–äº¤æ˜“ç³»ç»Ÿ-Windows
        path: dist/é‡åŒ–äº¤æ˜“ç³»ç»Ÿ.exe
        retention-days: 30

  # macOS Intel æ„å»ºå·²è¢« GitHub å¼ƒç”¨ï¼Œæš‚æ—¶ç¦ç”¨
  # build-macos-intel:
  #   name: æ‰“åŒ… macOS Intel å¯æ‰§è¡Œæ–‡ä»¶
  #   runs-on: macos-13

  build-macos-arm:
    name: æ‰“åŒ… macOS Apple Silicon å¯æ‰§è¡Œæ–‡ä»¶
    runs-on: macos-latest  # Apple Silicon Mac

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: è®¾ç½® Python ç¯å¢ƒ
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'

    - name: å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller

    - name: è¿è¡Œ PyInstaller æ‰“åŒ…
      run: |
        pyinstaller --clean \
          --name="é‡åŒ–äº¤æ˜“ç³»ç»Ÿ" \
          --windowed \
          --onefile \
          --icon=icon.ico \
          --add-data "icon.png:." \
          --add-data "backtest_worker.py:." \
          --add-data "download_worker.py:." \
          --add-data "paper_trading_worker.py:." \
          --add-data "config:config" \
          --add-data "strategies:strategies" \
          --add-data "tools:tools" \
          --hidden-import=PyQt5 \
          --hidden-import=pandas \
          --hidden-import=numpy \
          --hidden-import=cryptography \
          --hidden-import=ccxt \
          --hidden-import=requests \
          --collect-all=PyQt5 \
          --collect-all=pandas \
          --collect-all=numpy \
          trading_gui.py

    - name: åˆ›å»º .app åŒ…
      run: |
        mkdir -p "é‡åŒ–äº¤æ˜“ç³»ç»Ÿ.app/Contents/MacOS"
        mkdir -p "é‡åŒ–äº¤æ˜“ç³»ç»Ÿ.app/Contents/Resources"
        cp dist/é‡åŒ–äº¤æ˜“ç³»ç»Ÿ "é‡åŒ–äº¤æ˜“ç³»ç»Ÿ.app/Contents/MacOS/"
        cp icon.png "é‡åŒ–äº¤æ˜“ç³»ç»Ÿ.app/Contents/Resources/"

        cat > "é‡åŒ–äº¤æ˜“ç³»ç»Ÿ.app/Contents/Info.plist" << EOF
        <?xml version="1.0" encoding="UTF-8"?>
        <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
        <plist version="1.0">
        <dict>
            <key>CFBundleExecutable</key>
            <string>é‡åŒ–äº¤æ˜“ç³»ç»Ÿ</string>
            <key>CFBundleIconFile</key>
            <string>icon.png</string>
            <key>CFBundleIdentifier</key>
            <string>com.cryptor.trading</string>
            <key>CFBundleName</key>
            <string>é‡åŒ–äº¤æ˜“ç³»ç»Ÿ</string>
            <key>CFBundlePackageType</key>
            <string>APPL</string>
            <key>CFBundleShortVersionString</key>
            <string>2.0.0</string>
        </dict>
        </plist>
        EOF

        chmod +x "é‡åŒ–äº¤æ˜“ç³»ç»Ÿ.app/Contents/MacOS/é‡åŒ–äº¤æ˜“ç³»ç»Ÿ"
        zip -r "é‡åŒ–äº¤æ˜“ç³»ç»Ÿ-macOS-ARM.zip" "é‡åŒ–äº¤æ˜“ç³»ç»Ÿ.app"

    - name: ä¸Šä¼  macOS ARM å¯æ‰§è¡Œæ–‡ä»¶
      uses: actions/upload-artifact@v4
      with:
        name: é‡åŒ–äº¤æ˜“ç³»ç»Ÿ-macOS-ARM
        path: é‡åŒ–äº¤æ˜“ç³»ç»Ÿ-macOS-ARM.zip
        retention-days: 30

  create-release:
    name: åˆ›å»º GitHub Release
    needs: [build-windows, build-macos-arm]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')

    steps:
    - name: ä¸‹è½½æ‰€æœ‰ artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts

    - name: æ˜¾ç¤ºä¸‹è½½çš„æ–‡ä»¶
      run: |
        echo "ä¸‹è½½çš„ artifacts:"
        ls -R artifacts/

    - name: åˆ›å»º Release å¹¶ä¸Šä¼ æ–‡ä»¶
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        # åˆ›å»º Release è¯´æ˜
        cat > release_notes.md << 'EOF'
        # é‡åŒ–äº¤æ˜“ç³»ç»Ÿ ${{ github.ref_name }} (Pre-release)

        ## ğŸ‰ é¢„å‘å¸ƒç‰ˆæœ¬

        ### âœ¨ ä¸»è¦åŠŸèƒ½
        - ğŸ“¥ å¤šäº¤æ˜“æ‰€æ•°æ®ä¸‹è½½ï¼ˆBinanceã€OKXã€HTXï¼‰
        - ğŸ“Š ç­–ç•¥å›æµ‹åŠŸèƒ½
        - ğŸ® æ¨¡æ‹Ÿäº¤æ˜“åŠŸèƒ½
        - ğŸ“‹ ç­–ç•¥ç®¡ç†åŠŸèƒ½
        - ğŸ” ç­–ç•¥åŠ å¯†ä¿æŠ¤
        - ğŸ“ˆ æ”¯æŒ 13 ç§ K çº¿å‘¨æœŸï¼ˆ1m, 3m, 5m, 15m, 30m, 1h, 2h, 4h, 6h, 12h, 1d, 1w, 1Mï¼‰

        ### ğŸ“¦ ä¸‹è½½è¯´æ˜
        1. æ ¹æ®ä½ çš„ç³»ç»Ÿä¸‹è½½å¯¹åº”çš„æ–‡ä»¶ï¼š
           - **Windows**: `é‡åŒ–äº¤æ˜“ç³»ç»Ÿ.exe`
           - **macOS (Apple Silicon)**: `é‡åŒ–äº¤æ˜“ç³»ç»Ÿ-macOS-ARM.zip`
        2. Windows: ç›´æ¥è¿è¡Œ `.exe` æ–‡ä»¶
        3. macOS: è§£å‹ `.zip` åè¿è¡Œ `.app` æ–‡ä»¶

        ### âš ï¸ æ³¨æ„äº‹é¡¹
        - è¿™æ˜¯é¢„å‘å¸ƒç‰ˆæœ¬ï¼Œå¯èƒ½å­˜åœ¨æœªçŸ¥é—®é¢˜
        - è¯·åœ¨æµ‹è¯•ç¯å¢ƒä¸­ä½¿ç”¨
        - æ¬¢è¿åé¦ˆé—®é¢˜å’Œå»ºè®®

        ---

        **âš ï¸ å…è´£å£°æ˜**: æœ¬è½¯ä»¶ä»…ä¾›å­¦ä¹ å’Œç ”ç©¶ä½¿ç”¨ã€‚åŠ å¯†è´§å¸äº¤æ˜“å…·æœ‰é«˜é£é™©ï¼Œè¯·è°¨æ…ä½¿ç”¨ã€‚
        EOF

        # åˆ›å»º Release
        gh release create ${{ github.ref_name }} \
          --repo ${{ github.repository }} \
          --title "é‡åŒ–äº¤æ˜“ç³»ç»Ÿ ${{ github.ref_name }}" \
          --notes-file release_notes.md \
          --prerelease \
          artifacts/é‡åŒ–äº¤æ˜“ç³»ç»Ÿ-Windows/é‡åŒ–äº¤æ˜“ç³»ç»Ÿ.exe \
          artifacts/é‡åŒ–äº¤æ˜“ç³»ç»Ÿ-macOS-ARM/é‡åŒ–äº¤æ˜“ç³»ç»Ÿ-macOS-ARM.zip

